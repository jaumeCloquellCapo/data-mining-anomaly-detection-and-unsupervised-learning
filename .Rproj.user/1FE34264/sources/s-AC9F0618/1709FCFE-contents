---
title: "Cancer"
output: html_document
---


```{r setup, include=FALSE}
library(grid) 
library(gridExtra)
library(tidyverse)
library(dummies)
library(readxl)
library(knitr)
library(ggplot2)
library(lubridate)
library(arules)
library(arulesViz)
library(plyr)
library(corrplot)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

El dataset está compuesto por 286 registros de pacientes que presentaron o no recurrencia de cáncer de mama despues de cinco años de una cirugía. Los atributos no son suficientes para discriminar con mucha precisión entre las dos clases, pero son un muy buen ejemplo para aprender a procesar datos.

```{r}
cancer.dataset <- read.csv(url("https://archive.ics.uci.edu/ml/machine-learning-databases/breast-cancer/breast-cancer.data"), header=FALSE, col.names = c("recurrencia", "edad", "menopausia", "tamano", "nodulos", "capsula", "grado", "mama", "cuadrante", "radiot"))
str(cancer.dataset)
```


1. Edad: edad (en años en el último cumpleaños) del paciente.
en el momento del diagnóstico;
2. Menopausia: si el paciente es pre o posmenopáusica en el momento del diagnóstico;
3. Tamaño del tumor: el mayor diámetro (en mm) del tumor extirpado;
4. Inv-nodos: el número (rango 0 - 39) de ganglios linfáticos axilares que contienen cáncer de mama metastásico visible en el examen histológico;
5. Cápsulas de los nodos: si el cáncer se metastatiza en un ganglio linfático, aunque fuera del sitio original del tumor, puede permanecer "contenido" por la cápsula del ganglio linfático. Sin embargo, con el tiempo y con una enfermedad más agresiva, el tumor puede reemplazar el ganglio linfático y luego penetrar en la cápsula, lo que le permite invadir los tejidos circundantes;
6. Grado de malignidad: el grado histológico (rango 1-3) del tumor. Los tumores que son de grado 1 consisten predominantemente en células que, aunque son neoplásicas, conservan muchas de sus características habituales. Los tumores de grado 3 consisten predominantemente de células
que son altamente anormales;
7. Seno: el cáncer de seno puede ocurrir obviamente en cualquiera de los senos;
8. Cuadrante de mama: la mama se puede dividir en cuatro cuadrantes, utilizando el pezón como un punto central;
9. Irradiación: la radioterapia es un tratamiento que utiliza rayos X de alta energía para destruir las células cancerosas

```{r}
conv_rangos <- function(vect){
  aux_1 <- strsplit(vect, "-")
  aux_2 <- lapply(aux_1, function(x) as.numeric(x))
  convertido <- sapply(aux_2, mean)
  return(convertido)  
}
```


```{r}
df_crudo <- cancer.dataset
#edad_c <- df_crudo$edad
#edad_c <- sub("20-29", 1, edad_c)
#edad_c <- sub("30-39", 2, edad_c)
#edad_c <- sub("40-49", 3, edad_c)
#edad_c <- sub("50-59", 4, edad_c)
#edad_c <- sub("60-69", 5, edad_c)
#edad_c <- sub("70-79", 6, edad_c)
#edad_c <- as.numeric(edad_c)
menop_c <- as.factor(df_crudo$menopausia)
#tam_c <- conv_rangos(df_crudo$tamano)
cap_c <- df_crudo$capsula
cap_c[cap_c == "nan"] <- NA

cuad_c <- df_crudo$cuadrante
cuad_c[cuad_c == "nan"] <- NA
radiot_c <- df_crudo$radiot

recur_c <- df_crudo$recurrencia
recur_c <- ifelse(recur_c == "recurrence-events", 1, 0)

#nod_c <- conv_rangos(df_crudo$nodulos)
df1 <- data.frame(as.factor(df_crudo$edad), menop_c, df_crudo$tamano, 
                 df_crudo$nodulo, cap_c, as.factor(df_crudo$grado),
                 df_crudo$mama, cuad_c, radiot_c,
                 as.factor(recur_c))

names(df1) <- c("edad", "menopausia", "tamano", "nodulos", "capsula", "grado", "mama", "cuadrante", "radiot", "recurrencia")

cancer.dataset <- df1
```


```{r}
cancer.transactions <- as(df1,"transactions") 
itemFrequencyPlot(cancer.transactions, support=0.1, cex.names=0.8)
```



```{r, results='hide'}
car.rules <- apriori(cancer.transactions, parameter=list(support=0.1,target="frequent"))
car.rules.sorted <- sort(car.rules, by="support")
barplot(table(size(car.rules)), xlab="itemset size", ylab="count")
inspect(head(car.rules))
```



```{r, results='hide'}
car.rules <- apriori(cancer.transactions, parameter = list(minlen=3, supp=0.08, confidence=0.70), appearance=list(rhs=c("recurrencia=0","recurrencia=1")))
car.rules <- deleteRebundantRules(car.rules)
car.rules.sorted <- sort(car.rules, by="support")
inspect(car.rules.sorted)
plot(car.rules)
```

Hasta el momento sabemos que hay variables que no parecen estar aociadas con la probabilidad de recurrencia:

Edad
Menopausia
Mama
Cuadrante
Y otras variables que sí parecen ser importantes:

Tamaño del tumor
Cantidad de nódulos comprometidos (transformada a una variable categórica)
Grado de malignidad (histológico)
Cápsula (ćelulas cancerosas fuera de las cápsulas de los nódulos)
Radioterapia
Algunas de las variables no importantes, pueden serlo cuando se las considera en conjunto con otras (interacciones), y algunas variables pueden presentar colinealidad entre ellas; es decir, que están asociadas entre ellas.

## Reglas específicas mediante filtrado

```{r}
deleteRebundantRules <- function (rules) {
  subsetMatrix <- is.subset(rules, rules)
  subsetMatrix[lower.tri(subsetMatrix, diag=TRUE)] <- FALSE
  redundant <- colSums(subsetMatrix, na.rm=TRUE) >= 1
  rules <- rules[!redundant]
  return (rules)
}
```


Las células cancerosas fuera de las cápsulas de los nódulos linfáticos junto con eñ número de nódulos afectados está relacionado con la tasa de recurrencias.

```{r, results='hide'}
car.rules <- apriori(cancer.transactions, parameter = list(minlen=3, supp=0.08, conf=0.75))
car.rules <- deleteRebundantRules(car.rules)
car.rules.sorted <- sort(car.rules, by="support")
inspect(car.rules.sorted)
plot(car.rules)
plot(car.rules, method="graph", control=list(type="items"), measure='support', shading='confidence')
plot(car.rules, method="paracoord", reorder=TRUE)
plot(car.rules, method="grouped")
```

